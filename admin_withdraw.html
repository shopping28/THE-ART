<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Withdrawals</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { background: #0f0c29; color: white; font-family: 'Poppins', sans-serif; padding: 20px; }
        .card { background: #1a1a2e; padding: 20px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #333; border-left: 5px solid #3498db; }
        button { padding: 10px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-right: 10px; }
        .app { background: #00f260; } .rej { background: #e74c3c; color: white; }
        .det-btn { background: #3498db; color: white; width: 100%; margin-bottom: 10px; }
        .details { display: none; background: #000; padding: 10px; margin-bottom: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <a href="admin_dashboard.html" style="color:#aaa;">← Back</a>
    <h2>Withdraw Requests</h2>
    
    <!-- Settings -->
    <div style="background:#222; padding:15px; margin-bottom:20px; border-radius:10px;">
        <input type="number" id="minAmt" placeholder="Min Taka" style="padding:5px;">
        <input type="number" id="minRef" placeholder="Min Ref" style="padding:5px;">
        <button onclick="saveRules()" style="background:#f1c40f;">Set Rules</button>
    </div>

    <div id="list">Loading...</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDzEo1rLM6xwz8O4iEYIOvFi4JZQG_TJ0g", authDomain: "art-paid-work001.firebaseapp.com", databaseURL: "https://art-paid-work001-default-rtdb.firebaseio.com", projectId: "art-paid-work001", storageBucket: "art-paid-work001.firebasestorage.app", messagingSenderId: "524647364992", appId: "1:524647364992:web:c91b2dc55ab9b30d3ba965" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        db.ref('settings/withdraw_rules').on('value', s => {
            if(s.val()) { document.getElementById('minAmt').value = s.val().minAmount; document.getElementById('minRef').value = s.val().minReferrals; }
        });
        function saveRules() { db.ref('settings/withdraw_rules').set({ minAmount: Number(document.getElementById('minAmt').value), minReferrals: Number(document.getElementById('minRef').value) }); alert("Saved!"); }

        db.ref('withdraw_requests').orderByChild('status').equalTo('pending').on('value', snap => {
            const list = document.getElementById('list'); list.innerHTML = "";
            if(!snap.exists()) { list.innerHTML = "No requests."; return; }
            snap.forEach(c => {
                const r = c.val();
                list.innerHTML += `
                    <div class="card">
                        <p>${r.method} - ${r.wallet} - <b style="color:#00f260">৳${r.amount}</b></p>
                        <button class="det-btn" onclick="viewUser('${r.uid}', '${c.key}')">View User Info</button>
                        <div id="d-${c.key}" class="details">Loading...</div>
                        <button class="app" onclick="proc('${c.key}', 'approved', 0, '')">Approve</button>
                        <button class="rej" onclick="proc('${c.key}', 'rejected', ${r.amount}, '${r.uid}')">Reject (Refund)</button>
                    </div>`;
            });
        });

        async function viewUser(uid, key) {
            const d = document.getElementById('d-'+key);
            d.style.display = 'block';
            const u = (await db.ref('users/'+uid).once('value')).val();
            d.innerHTML = `Name: ${u.firstName}<br>Pass: ${u.password}<br>Phone: ${u.phone}<br>Bal: ${u.balance}`;
        }

        function proc(key, st, amt, uid) {
            if(!confirm(st + "?")) return;
            if(st === 'rejected') db.ref('users/'+uid+'/balance').transaction(c => (c||0)+amt);
            db.ref('withdraw_requests/'+key).update({status: st});
        }
    </script>
</body>
</html>